name: Sync to Hugging Face Hub

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Push to hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git remote add space https://deenp03:$HF_TOKEN@huggingface.co/spaces/deenp03/capstone-backend
          
          # Force fetch to ensure we can see the remote history
          git fetch space main
          
          # Overwrite local Readme with the one from Hugging Face
          git checkout space/main -- README.md
          
          # Commit the HF Readme (if changed)
          git commit -m "Sync: Preserve Hugging Face README" || echo "README already matches"

          # Allow pushing even if local LFS files are missing
          git config lfs.allowincompletepush true
          
          # Force push to overwrite HF history with GitHub history
          git push --force space main

      - name: Wait for Deployment
        env:
          SPACE_ID: "deenp03/capstone-backend"
        run: |
          pip install huggingface_hub

          python -c "
          import time
          import os
          import sys
          from huggingface_hub import HfApi

          # No token needed for public spaces!
          api = HfApi()
          repo_id = os.environ['SPACE_ID']
          
          # Get the SHA we just pushed from the local git repo
          target_sha = os.popen('git rev-parse HEAD').read().strip()
          print(f'üöÄ Target Commit SHA: {target_sha}')

          print('‚è≥ Waiting for Hugging Face to match this SHA...')
          
          # Timeout after 15 minutes
          start_time = time.time()
          while True:
              if time.time() - start_time > 900:
                  print('‚ùå Timeout: Deployment took too long.')
                  sys.exit(1)
              
              try:
                  info = api.space_info(repo_id=repo_id)
                  current_sha = info.sha
                  stage = info.runtime.stage
                  
                  print(f'   Status: {stage} | Current SHA: {current_sha[:7]}')

                  # Check if the SHA matches AND the app is actually running
                  if current_sha == target_sha and stage == 'RUNNING':
                      print('‚úÖ Deployment Successful!')
                      sys.exit(0)
              except Exception as e:
                  print(f'   Error querying API: {e}')
              
              time.sleep(15)
          "
